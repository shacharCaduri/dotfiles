#!/usr/bin/env bash

# Color codes for formatting
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration file path
CONFIG_FILE="${HOME}/.gitenv"

# Function to validate email
validate_email() {
    local email="$1"
    if [[ ! "$email" =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$ ]]; then
        return 1
    fi
    return 0
}

# Function to prompt for input with validation
prompt_input() {
    local prompt="$1"
    local variable_name="$2"
    local validation_func="${3:-}"
    local input=""

    while true; do
        read -p "${BLUE}${prompt}${NC} " input
        
        # If validation function exists, use it
        if [[ -n "$validation_func" ]]; then
            if $validation_func "$input"; then
                break
            else
                echo -e "${RED}Invalid input. Please try again.${NC}"
            fi
        # If no validation, just ensure input is not empty
        elif [[ -n "$input" ]]; then
            break
        else
            echo -e "${RED}This field cannot be empty. Please enter a value.${NC}"
        fi
    done

    # Export and save the variable
    export "$variable_name"="$input"
    echo "export $variable_name=\"$input\"" >> "$CONFIG_FILE"
}

# Clear existing config file
> "$CONFIG_FILE"

# Welcome message
echo -e "${GREEN}===== Git Environment Configuration =====${NC}"
echo -e "${YELLOW}This script will help you set up Git environment variables.${NC}"
echo -e "${YELLOW}Please provide values for each configuration option.${NC}"

# User Information
echo -e "\n${BLUE}=== User Information ===${NC}"
prompt_input "Enter your full name:" GIT_USER_NAME
prompt_input "Enter your email address:" GIT_USER_EMAIL validate_email

# Editor Configuration
echo -e "\n${BLUE}=== Editor Configuration ===${NC}"
prompt_input "Preferred Git editor (default: vim):" GIT_EDITOR

# Branch Configurations
echo -e "\n${BLUE}=== Branch Configurations ===${NC}"
prompt_input "Default main branch name:" GIT_DEFAULT_BRANCH
prompt_input "Default master branch name:" GIT_MASTER_BRANCH

# Pull and Push Configurations
echo -e "\n${BLUE}=== Repository Workflow ===${NC}"
echo -e "${YELLOW}Choose pull rebase behavior:${NC}"
select pull_rebase in "true" "false"; do
    export GIT_PULL_REBASE="$pull_rebase"
    echo "export GIT_PULL_REBASE=\"$pull_rebase\"" >> "$CONFIG_FILE"
    break
done

echo -e "\n${BLUE}=== Push Configuration ===${NC}"
prompt_input "Push default behavior (current/simple/matching):" GIT_PUSH_DEFAULT

# Color Configurations
echo -e "\n${BLUE}=== Color Preferences ===${NC}"
prompt_input "Git UI color mode (auto/always/never):" GIT_COLOR_UI

# Advanced Color Configurations
echo -e "\n${BLUE}=== Advanced Color Settings ===${NC}"
prompt_input "Branch current color:" GIT_COLOR_BRANCH_CURRENT
prompt_input "Branch local color:" GIT_COLOR_BRANCH_LOCAL
prompt_input "Branch remote color:" GIT_COLOR_BRANCH_REMOTE

prompt_input "Diff meta color:" GIT_COLOR_DIFF_META
prompt_input "Diff commit color:" GIT_COLOR_DIFF_COMMIT
prompt_input "Diff fragment color:" GIT_COLOR_DIFF_FRAG
prompt_input "Diff old line color:" GIT_COLOR_DIFF_OLD
prompt_input "Diff new line color:" GIT_COLOR_DIFF_NEW

prompt_input "Status added color:" GIT_COLOR_STATUS_ADDED
prompt_input "Status changed color:" GIT_COLOR_STATUS_CHANGED
prompt_input "Status untracked color:" GIT_COLOR_STATUS_UNTRACKED

# Additional Configurations
echo -e "\n${BLUE}=== Additional Git Settings ===${NC}"
prompt_input "Help autocorrect delay (0 to disable):" GIT_HELP_AUTOCORRECT

# Source configuration
echo -e "\n${GREEN}=== Configuration Complete ===${NC}"
echo -e "${YELLOW}Adding configuration to ${CONFIG_FILE}${NC}"

# Add sourcing to shell configuration
SHELL_CONFIG=""
if [[ -f "$HOME/.zshrc" ]]; then
    SHELL_CONFIG="$HOME/.zshrc"
elif [[ -f "$HOME/.bashrc" ]]; then
    SHELL_CONFIG="$HOME/.bashrc"
fi

if [[ -n "$SHELL_CONFIG" ]]; then
    # Check if already sourced
    if ! grep -q "source ${CONFIG_FILE}" "$SHELL_CONFIG"; then
        echo -e "\n# Source Git environment variables\nsource \"${CONFIG_FILE}\"" >> "$SHELL_CONFIG"
        echo -e "${GREEN}Configuration sourced in ${SHELL_CONFIG}${NC}"
    fi
fi

echo -e "${GREEN}Git environment setup complete!${NC}"
echo -e "${YELLOW}Please restart your terminal or run 'source ${CONFIG_FILE}' to apply changes.${NC}"
